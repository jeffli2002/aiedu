# Cloudflare R2 存储配置指南

本指南将帮助您获取 Cloudflare R2 存储所需的访问密钥和配置信息。

## 前置要求

- 拥有 Cloudflare 账户
- 已启用 R2 存储服务（可能需要付费计划）

---

## 步骤 1：登录 Cloudflare Dashboard

1. 访问 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 使用您的账户登录

---

## 步骤 2：创建 R2 Bucket（如果还没有）

1. 在左侧导航栏中，点击 **"R2"** 或 **"Workers & Pages"** > **"R2"**
2. 点击 **"Create bucket"**（创建存储桶）
3. 输入存储桶名称（例如：`future-ai-creators-media`）
4. 选择存储位置（建议选择离用户最近的区域）
5. 点击 **"Create bucket"** 完成创建

---

## 步骤 3：获取 R2 访问密钥（API Token）

### ⚠️ 重要区别

- **Account API Tokens**（账户 API 令牌）：用于访问 Cloudflare API 的通用令牌
- **R2 API Tokens**（R2 API 令牌）：专门用于 R2 存储的访问密钥，提供 `Access Key ID` 和 `Secret Access Key`

您需要的是 **R2 API Tokens**，不是 Account API Tokens！

### 方法 1：直接访问 R2 API Tokens URL（最简单）

如果 R2 页面没有显示 "Manage R2 API Tokens" 链接，可以直接访问：

**直接访问链接：**
```
https://dash.cloudflare.com/?to=/:account/r2/api-tokens
```

**步骤：**
1. 复制上面的链接
2. 将 `:account` 替换为您的 Account ID（在 R2 Overview 页面的 "Account Details" 部分可以看到，例如：`ccb5990ee93ad99d5ada77b738e9...`）
3. 或者直接访问：`https://dash.cloudflare.com/ccb5990ee93ad99d5ada77b738e9/r2/api-tokens`（替换为您的实际 Account ID）

### 方法 2：从 R2 页面查找

1. **进入 R2 管理页面**
   - 在 Cloudflare Dashboard 左侧导航栏，点击 **"R2"** 或 **"Workers & Pages"** > **"R2"**

2. **查找 API Tokens 入口**
   - 在 R2 Overview 页面，查看右上角或页面顶部是否有 **"API Tokens"** 或 **"Manage R2 API Tokens"** 链接
   - 或者点击某个存储桶（如 "aiedu" 或 "viecom"），在存储桶设置页面查找 API Tokens 选项

3. **创建 R2 API Token**
   - 在 R2 API Tokens 页面，点击 **"Create API token"**（创建 API 令牌）
   - 输入令牌名称（例如：`Future AI Creators R2 Token`）
   - 选择权限：
     - ✅ **Object Read & Write**（对象读写权限）
     - ✅ **Admin Read**（管理读取权限，可选）
   - 选择存储桶：
     - 选择 **"Allow access to specific buckets"**（允许访问特定存储桶）
     - 选择您要使用的存储桶
   - 点击 **"Create API Token"**（创建 API 令牌）

4. **保存访问密钥**
   - ⚠️ **重要**：密钥只会显示一次，请立即复制并保存
   - 您会看到：
     - **Access Key ID**（访问密钥 ID）→ 这就是 `R2_ACCESS_KEY_ID`
     - **Secret Access Key**（秘密访问密钥）→ 这就是 `R2_SECRET_ACCESS_KEY`
   - 将这两个值保存到安全的地方（例如 `.env.local` 文件）

### 方法 1.5：查看现有 R2 Token（如果已创建）

如果您已经创建了 R2 API Token（例如截图中的 "viecom-r2-storage"）：

1. **注意**：出于安全考虑，Cloudflare **不会再次显示**已创建的 `Secret Access Key`
2. **解决方案**：
   - 如果忘记了 Secret Access Key，您需要**创建新的 R2 API Token**
   - 可以删除旧的 token，然后创建新的
   - 或者创建新的 token 后，再删除旧的

---

### 方法 3：使用 Cloudflare API 创建（如果界面找不到）

如果您无法在界面中找到 R2 API Tokens 页面，可以使用 Cloudflare API 创建：

1. **获取 Account ID**
   - 在 R2 Overview 页面的 "Account Details" 部分，找到 **"Account ID"**
   - 点击复制图标复制 Account ID（例如：`ccb5990ee93ad99d5ada77b738e9...`）

2. **创建 Account API Token**（用于调用 Cloudflare API）

   **方法 A：使用模板（推荐）**
   - 访问：https://dash.cloudflare.com/profile/api-tokens
   - 点击 **"Create Token"**
   - 在模板列表中找到并选择 **"Edit Cloudflare Workers"** 模板
   - 这个模板通常包含 R2 的权限
   - 点击 **"Continue to summary"** > **"Create Token"**
   - 复制生成的 Token

   **方法 B：如果模板不可用，尝试自定义权限**
   - 在 "Create Custom Token" 页面：
     - **第一个下拉菜单**：选择 **"Account"**
     - **第二个下拉菜单**：尝试输入并选择以下选项之一：
       - **"Workers"**（R2 通常与 Workers 相关）
       - **"Workers Scripts"**
       - 或者直接输入 **"R2"** 搜索
     - **第三个下拉菜单**：选择 **"Edit"**
   - 如果仍然找不到，尝试：
     - **Account** > **Workers** > **Edit**
   - 点击 **"Continue to summary"** > **"Create Token"**
   - 复制生成的 Token

3. **使用 API 创建 R2 访问密钥**
   
   在 PowerShell 中运行（替换 `{ACCOUNT_ID}` 和 `{API_TOKEN}` 为实际值）：
   
   ```powershell
   $accountId = "ccb5990ee93ad99d5ada77b738e9"  # 替换为您的 Account ID
   $apiToken = "your-api-token-here"  # 替换为步骤2创建的 API Token
   $bucketName = "aiedu"  # 替换为您的存储桶名称（可选，部分端点不需要）

   $headers = @{
       "Authorization" = "Bearer $apiToken"
       "Content-Type" = "application/json"
   }

   # 2024+ 推荐端点：/r2/s3/keys（仅需要 name）
   $body = @{ name = "aiedu-r2-token" } | ConvertTo-Json

   $response = Invoke-RestMethod -Uri "https://api.cloudflare.com/client/v4/accounts/$accountId/r2/s3/keys" -Method Post -Headers $headers -Body $body
   $result = if ($response.result) { $response.result } else { $response }

   Write-Host "Access Key ID: $($result.access_key_id)"
   Write-Host "Secret Access Key: $($result.secret_access_key)"
   ```
   
   或者使用 curl（如果已安装）：
   
   ```bash
   curl -X POST "https://api.cloudflare.com/client/v4/accounts/{ACCOUNT_ID}/r2/s3/keys" \
     -H "Authorization: Bearer {API_TOKEN}" \
     -H "Content-Type: application/json" \
     --data '{"name":"aiedu-r2-token"}'
   ```

4. **保存返回的密钥**
   - 响应中会包含 `access_key_id` 和 `secret_access_key`
   - 这就是您需要的 `R2_ACCESS_KEY_ID` 和 `R2_SECRET_ACCESS_KEY`

---

## 步骤 4：获取 R2 Endpoint 和 Public URL

### R2 Endpoint（端点）

R2 Endpoint 的格式为：
```
https://{account-id}.r2.cloudflarestorage.com
```

**获取 Account ID：**
1. 在 Cloudflare Dashboard 右侧边栏找到 **"Account ID"**
2. 复制这个 ID
3. Endpoint 格式：`https://{您的AccountID}.r2.cloudflarestorage.com`

### R2 Public URL（公共访问 URL）

有两种方式设置公共访问：

#### 选项 1：使用 R2 自定义域名（推荐）

1. **绑定自定义域名**
   - 在 R2 存储桶设置中，找到 **"Public Access"** 或 **"Custom Domain"**
   - 添加您的自定义域名（例如：`media.yourdomain.com`）
   - 按照提示配置 DNS 记录

2. **Public URL 格式**
   ```
   https://media.yourdomain.com
   ```

#### 选项 2：使用 R2.dev 子域名

1. **启用公共访问**
   - 在存储桶设置中，启用 **"Public Access"**
   - Cloudflare 会提供一个 `r2.dev` 子域名

2. **Public URL 格式**
   ```
   https://{bucket-name}.{account-id}.r2.cloudflarestorage.com
   ```

---

## 步骤 5：配置环境变量

在项目的 `.env.local` 文件中添加以下配置：

```bash
# R2 Storage (Cloudflare)
R2_BUCKET_NAME="your-bucket-name"
R2_ACCESS_KEY_ID="your-access-key-id"
R2_SECRET_ACCESS_KEY="your-secret-access-key"
R2_ENDPOINT="https://your-account-id.r2.cloudflarestorage.com"
R2_PUBLIC_URL="https://your-custom-domain.com"
# 或使用 R2.dev 子域名：
# R2_PUBLIC_URL="https://your-bucket-name.your-account-id.r2.cloudflarestorage.com"
```

### 配置示例

```bash
# R2 Storage (Cloudflare)
R2_BUCKET_NAME="future-ai-creators-media"
R2_ACCESS_KEY_ID="a1b2c3d4e5f6g7h8i9j0"
R2_SECRET_ACCESS_KEY="your-secret-key-here-very-long-string"
R2_ENDPOINT="https://abc123def456.r2.cloudflarestorage.com"
R2_PUBLIC_URL="https://media.futureaicreators.com"
```

---

## 步骤 6：验证配置

配置完成后，重启开发服务器：

```bash
pnpm dev
```

检查控制台是否有 R2 连接错误。如果一切正常，您应该能够：
- 上传图片到 R2
- 生成视频并存储到 R2
- 通过公共 URL 访问存储的文件

---

## 安全建议

1. **保护访问密钥**
   - 永远不要将 `.env.local` 文件提交到 Git
   - 确保 `.env.local` 在 `.gitignore` 中
   - 使用环境变量管理工具（如 Vercel、Railway 等）存储生产环境密钥

2. **限制 API Token 权限**
   - 只授予必要的权限（Object Read & Write）
   - 限制访问特定存储桶
   - 定期轮换访问密钥

3. **使用 CORS 配置**
   - 在 R2 存储桶设置中配置 CORS 规则
   - 限制允许的来源域名

---

## 故障排除

### 问题 1：无法连接到 R2

**解决方案：**
- 检查 `R2_ENDPOINT` 格式是否正确
- 确认 Account ID 是否正确
- 验证访问密钥是否有效

### 问题 2：上传失败

**解决方案：**
- 检查存储桶名称是否正确
- 确认 API Token 有写入权限
- 检查文件大小是否超过限制

### 问题 3：无法通过公共 URL 访问文件

**解决方案：**
- 确认已启用存储桶的公共访问
- 检查自定义域名 DNS 配置
- 验证 CORS 设置

---

## 参考资源

- [Cloudflare R2 文档](https://developers.cloudflare.com/r2/)
- [R2 API 参考](https://developers.cloudflare.com/r2/api/)
- [R2 定价](https://developers.cloudflare.com/r2/pricing/)

---

## 快速检查清单

- [ ] 已创建 Cloudflare 账户
- [ ] 已创建 R2 存储桶
- [ ] 已获取 Access Key ID
- [ ] 已获取 Secret Access Key
- [ ] 已获取 Account ID
- [ ] 已配置 R2 Endpoint
- [ ] 已设置 R2 Public URL（自定义域名或 r2.dev）
- [ ] 已在 `.env.local` 中配置所有变量
- [ ] 已测试上传功能

---

如有问题，请参考 Cloudflare R2 官方文档或联系 Cloudflare 支持。

